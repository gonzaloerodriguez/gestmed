name: Daily Database Backup (Fixed)

on:
  schedule:
    - cron: "0 2 * * *" # Todos los d√≠as a las 2:00 AM UTC
  workflow_dispatch:

jobs:
  run_db_backup:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
    env:
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
      BACKUP_ENCRYPTION_KEY: ${{ secrets.BACKUP_ENCRYPTION_KEY }}
      BACKUP_ENABLED: true

    steps:
      - name: Check if backups are enabled
        run: |
          if [ "$BACKUP_ENABLED" != "true" ]; then
            echo "Backups are disabled. Exiting workflow."
            exit 0
          fi

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Supabase CLI (Official Action)
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Verify Supabase CLI installation
        run: |
          supabase --version
          echo "Supabase CLI instalado correctamente"

      - name: Login to Supabase
        run: |
          echo "$SUPABASE_ACCESS_TOKEN" | supabase login --token

      - name: Test Supabase connection
        run: |
          echo "Verificando conexi√≥n con Supabase..."
          supabase projects list

      - name: Create timestamp folder
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          mkdir -p backups/$TIMESTAMP
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          echo "Carpeta creada: backups/$TIMESTAMP"

      - name: Backup roles
        run: |
          echo "Creando backup de roles..."
          supabase db dump --db-url "$SUPABASE_DB_URL" -f backups/$TIMESTAMP/roles.sql --role-only
          echo "Backup de roles completado"

      - name: Backup schema
        run: |
          echo "Creando backup de schema..."
          supabase db dump --db-url "$SUPABASE_DB_URL" -f backups/$TIMESTAMP/schema.sql
          echo "Backup de schema completado"

      - name: Backup data
        run: |
          echo "Creando backup de datos..."
          supabase db dump --db-url "$SUPABASE_DB_URL" -f backups/$TIMESTAMP/data.sql --data-only --use-copy
          echo "Backup de datos completado"

      - name: Create complete backup
        run: |
          echo "Creando backup completo..."
          supabase db dump --db-url "$SUPABASE_DB_URL" -f backups/$TIMESTAMP/complete_backup.sql
          echo "Backup completo creado"

      - name: Verify backups
        run: |
          echo "Verificando archivos de backup..."
          ls -la backups/$TIMESTAMP/
          echo "Tama√±os de archivos:"
          du -h backups/$TIMESTAMP/*

      - name: Compress backups
        run: |
          echo "Comprimiendo backups..."
          cd backups
          tar -czf backup_$TIMESTAMP.tar.gz $TIMESTAMP/
          echo "Backup comprimido creado: backup_$TIMESTAMP.tar.gz"
          ls -la backup_$TIMESTAMP.tar.gz
          echo "Tama√±o del archivo comprimido: $(du -h backup_$TIMESTAMP.tar.gz | cut -f1)"

      - name: Encrypt backup
        run: |
          echo "Encriptando backup..."
          cd backups
          gpg --symmetric --cipher-algo AES256 --compress-algo 1 --s2k-mode 3 --s2k-digest-algo SHA512 --s2k-count 65536 --quiet --batch --passphrase "$BACKUP_ENCRYPTION_KEY" backup_$TIMESTAMP.tar.gz
          rm backup_$TIMESTAMP.tar.gz
          echo "Backup encriptado correctamente: backup_$TIMESTAMP.tar.gz.gpg"
          ls -la backup_$TIMESTAMP.tar.gz.gpg

      - name: Upload backup to release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: backup-${{ env.TIMESTAMP }}
          name: Database Backup ${{ env.TIMESTAMP }}
          files: backups/backup_${{ env.TIMESTAMP }}.tar.gz.gpg
          body: |
            üóÑÔ∏è **Backup Autom√°tico de Base de Datos**

            **Informaci√≥n del Backup:**
            - üìÖ Fecha: $(date +%Y-%m-%d)
            - ‚è∞ Hora: $(date +%H:%M:%S) UTC
            - üèÉ Run: ${{ github.run_number }}
            - üîß M√©todo: Supabase CLI oficial

            **Contenido del Backup:**
            - üë• Roles y permisos (roles.sql)
            - üèóÔ∏è Esquema de base de datos (schema.sql)
            - üìä Datos completos (data.sql)
            - üíæ Backup completo (complete_backup.sql)

            **Seguridad:**
            - üîí Archivo encriptado con AES256
            - üóúÔ∏è Comprimido con gzip

            **Para restaurar:**
            1. Descargar el archivo .gpg
            2. Desencriptar: `gpg --decrypt backup_${{ env.TIMESTAMP }}.tar.gz.gpg > backup.tar.gz`
            3. Extraer: `tar -xzf backup.tar.gz`
            4. Restaurar seg√∫n necesidad
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install GitHub CLI and cleanup old backups
        run: |
          echo "Instalando GitHub CLI..."
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

          echo "Limpiando backups antiguos..."
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

          # Mantener solo los √∫ltimos 30 backups
          RELEASES_TO_DELETE=$(gh release list --limit 50 | grep "backup-" | tail -n +31 | awk '{print $1}')

          if [ -n "$RELEASES_TO_DELETE" ]; then
            echo "Eliminando releases antiguos:"
            echo "$RELEASES_TO_DELETE"
            echo "$RELEASES_TO_DELETE" | xargs -I {} gh release delete {} --yes
            echo "Limpieza completada"
          else
            echo "No hay releases antiguos para eliminar"
          fi

      - name: Cleanup local files
        run: |
          echo "Limpiando archivos locales..."
          rm -rf backups/
          echo "Limpieza local completada"

      - name: Backup summary
        run: |
          echo "üéâ ¬°Backup completado exitosamente!"
          echo "üìã Resumen:"
          echo "   - Timestamp: $TIMESTAMP"
          echo "   - Release: backup-$TIMESTAMP"
          echo "   - Archivos incluidos: roles.sql, schema.sql, data.sql, complete_backup.sql"
          echo "   - Estado: Encriptado y subido a GitHub Releases"
          echo "   - Backups antiguos: Limpiados (manteniendo √∫ltimos 30)"

# # .github/workflows/backup-database.yml
# name: Daily Database Backup

# on:
#   schedule:
#     # Ejecutar diariamente a las 2:00 AM UTC
#     - cron: "0 2 * * *"
#   workflow_dispatch: # Permitir ejecuci√≥n manual

# jobs:
#   backup:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: "18"

#       - name: Install Supabase CLI
#         run: |
#           npm install -g supabase

#       - name: Login to Supabase
#         run: |
#           echo "${{ secrets.SUPABASE_ACCESS_TOKEN }}" | supabase login --token

#       - name: Create database backup
#         run: |
#           # Crear backup completo
#           supabase db dump --project-ref ${{ secrets.SUPABASE_PROJECT_REF }} --db-url ${{ secrets.SUPABASE_DB_URL }} > backup_$(date +%Y%m%d_%H%M%S).sql

#           # Comprimir backup
#           gzip backup_*.sql

#       - name: Encrypt backup
#         run: |
#           # Encriptar el backup
#           gpg --symmetric --cipher-algo AES256 --compress-algo 1 --s2k-mode 3 --s2k-digest-algo SHA512 --s2k-count 65536 --quiet --batch --passphrase "${{ secrets.BACKUP_ENCRYPTION_KEY }}" backup_*.sql.gz
#           rm backup_*.sql.gz # Eliminar archivo sin encriptar

#       - name: Upload backup to release
#         uses: softprops/action-gh-release@v1
#         with:
#              tag_name: backup-${{ github.run_id }}
#              name: Database Backup ${{ github.run_id }}
#           files: backup_*.sql.gz.gpg
#           body: |
#             Backup autom√°tico de base de datos
#             Fecha: $(date)
#             Tablas incluidas: doctors, patients, medical_histories, consultations, prescriptions
#         env:
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

#       - name: Cleanup old backups
#         run: |
#           # Mantener solo los √∫ltimos 30 backups
#           gh release list --limit 50 | grep "backup-" | tail -n +31 | awk '{print $1}' | xargs -I {} gh release delete {} --yes
#         env:
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
